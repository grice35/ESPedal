# ESPedal
For my final project in ECE 4180 - Embedded Systems Design at Georgia Tech, I decided to design and build a multi-effects pedal to be used with an electric guitar based around the ESP32-C6 microcontroller. The pedal alters the sound of the guitar by taking its analog signal as an input through a stereo jack, filtering and stabilizing the signal using op-amps and various filter circuits, modifying the signal in the digital domain using the ESP32, and then outputting the modified signal to a traditional guitar amplifier. Some of the main features/functionality of this pedal include digital and analog I/O, I2C wired communication, the ESP32’s deep sleep mode, interrupts tied to each event-triggered input source, and the ability to be externally powered by a wall adapter.
 
This project utilizes many of the components I had become accustomed to working with through previous assignments in this course along with new components that were required for the pedal to function properly. The user interface, which involves activating the pedal itself and switching between effects, consists of a pushbutton, toggle switch, and 3PDT footswitch for input and an LED and LCD display for output. I used the switch to bring the ESP32 in and out of deep sleep mode, which on wakeup turns on the LCD display, and I used the pushbutton to cycle through the different pedal modes and show them on the LCD. The purpose of the footswitch is to toggle the LED and activate the pedal simultaneously, which is done by switching the input and output jacks off of a bypass that connects their individual switches and onto wires that connect to the main pedal circuit. 

The main circuit of the pedal contains two new components - stereo jacks and op-amps - as well as a DAC with I2C communication, which was used in Lab 2. The stereo jacks allow the circuit to receive audio input from the guitar and send analog output to the amplifier. Having the input and output signals pass through op-amps at the end of the input and output stages help in both stepping up and stabilizing the voltage before reaching the ESP32’s onboard ADC and before being sent to the larger guitar amplifier. Using a 12-bit DAC was essential for the bit-crushed effect I was trying to create because it simultaneously converts the digital output of the ESP32 to analog and compresses the signal to make it sound like it’s from an old NES game. I also used an NPN transistor to allow the input signal to bypass the ESP32 altogether and go straight to the output stage for the traditional distortion effect. The resistors and capacitors scattered throughout the input and output stages of the circuit were used to create lowpass and highpass filters that eliminate any dull hums or high-pitched noises from the signal before it is sent to the guitar amp, and the trimmer resistor connected to the inverting input of the op-amp controls the gain of signal passed in.
 
Additionally, there are two power supply circuits that send certain voltages to different parts of the main circuit. One supplies a stable 5V to all of the components and the other supplies a virtual ground of 1.5V to the input stage.
 
The problems I ran into while working on this project mainly came from faulty hardware and materials, such as very loose pinholes on the breadboards I used and inconsistent connections between jumper wires and parts that could not be installed on a breadboard, which included both the toggle switch and the footswitch. I also had an issue with getting the PWM output to work with the circuit I built, which would only sometimes pick it up and would only output a very faint signal when it did no matter what I set the input gain to. I ultimately decided to scrap the effects I tried to make with PWM and settled with the 2 effects the pedal currently has. I also decided to drop the idea of using bluetooth to control the pedal remotely early on because I realized it would be an expensive feature both power and memory-wise that would probably be wasted on the average user of this pedal since there is rarely a situation where you would be far enough away from the pedal to warrant using your phone to interface with it.
 
I based many aspects of this project on a similar embedded guitar pedal from the ElectroSmash website called the “Pedal Pi” which uses a Raspberry Pi Zero to do the digital signal processing. I decided to use the ESP32 instead because it has the ability to do onboard analog-to-digital conversion and has the added convenience of being compatible with Arduino APIs, which include the deep sleep mode I used to conserve power while at the same time preserving the current effect setting. I also modified the circuit they used by adding the DAC and transistor to create some of the effects I wanted and the LCD to display the current effect mode.

If I had more time and resources to contribute toward this project, I would have made an effort to learn more about PCB design and used KiCad to create a custom circuit board for the pedal. Having a clean finalized design would alleviate many of the issues I came across during the design process, such as weak breadboard connections and faulty jumper wires. I would have also spent more time getting the PWM output to work consistently and used it to create more effects for the pedal. 

Overall, I am satisfied with the progress I made on my custom guitar pedal over the course of 3 weeks, and I plan to continue improving on it by adding new effects and eventually getting a PCB printed for it. This project taught me a great deal about analog I/O and digital signal processing in the context of embedded systems, and it has made me interested in further researching these topics and working with them in the future.
